(()=>{"use strict";var e={d:(t,n)=>{for(var i in n)e.o(n,i)&&!e.o(t,i)&&Object.defineProperty(t,i,{enumerable:!0,get:n[i]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},t={};e.r(t),e.d(t,{default:()=>A});const n=require("obsidian"),i=["note","abstract","info","todo","tip","success","question","warning","failure","danger","bug","example","quote"];const o="callout-manager";async function l(e){var t;if((null!=(t=e.app)?t:globalThis.app).plugins.enabledPlugins.has(o))return function(e){var t,n,i,l,s;return n=this,i=void 0,s=function*(){const n=null!==(t=null==e?void 0:e.app)&&void 0!==t?t:globalThis.app,{plugins:i}=n;if(!i.enabledPlugins.has(o))return;const l=yield new Promise(((e,t)=>{const n=i.plugins[o];if(void 0!==n)return e(n);const l=setInterval((()=>{const t=i.plugins[o];void 0!==t&&(clearInterval(l),e(t))}),10)}));return l.newApiHandle("v1",e,(()=>{l.destroyApiHandle("v1",e)}))},new((l=void 0)||(l=Promise))((function(e,t){function o(e){try{r(s.next(e))}catch(e){t(e)}}function a(e){try{r(s.throw(e))}catch(e){t(e)}}function r(t){var n;t.done?e(t.value):(n=t.value,n instanceof l?n:new l((function(e){e(n)}))).then(o,a)}r((s=s.apply(n,i||[])).next())}))}(e)}function s(e){return`wrap-lines-in-${e}-callout`}function a(e){return e[e.length-1]}function r(e,t){return e.filter((e=>!t.has(e)))}function u(e,t){const n=function(e,t){const n=e.exec(t);return n?.[1]}(e,t);return n?.trim()}function c(e){return e.split("\n")}const d=/^> \[!(\w+)\]/,f=/^> \[!\w+\] (.+)/,h=/^#+ (.+)/;function g({calloutID:e,title:t}){const n=function(e){return`> [!${e}]`}(e);return`${n} ${t}`}function m(e){return`${(t=e).charAt(0).toUpperCase()}${t.slice(1).toLowerCase()}`;var t}function C({editor:e,selectedLinesDiff:t,originalCursorPositions:n,selectedLinesRange:i}){const o=function({originalCursorPositions:e,selectedLinesDiff:t}){const{from:n,to:i}=e,o=function({oldFrom:e,selectedLinesDiff:t}){const{oldLines:n,newLines:i}=t;if(n.length!==i.length)return{line:e.line,ch:0};const o={oldLine:n[0],newLine:i[0]},l=p({oldCh:e.ch,lineDiff:o});return{line:e.line,ch:l}}({oldFrom:n,selectedLinesDiff:t}),l=function({oldTo:e,selectedLinesDiff:t}){const{oldLines:n,newLines:i}=t,o=i.length-n.length,l=e.line+o,s={oldLine:a(n),newLine:a(i)};return{line:l,ch:p({oldCh:e.ch,lineDiff:s})}}({oldTo:i,selectedLinesDiff:t});return{from:o,to:l}}({originalCursorPositions:n,selectedLinesDiff:t}),l=t.newLines.join("\n");e.replaceRange(l,i.from,i.to),function(e,t,n){const{newAnchor:i,newHead:o}=function(e,t){const{from:n,to:i}=t;return function({anchor:e,head:t}){return t.line<e.line||t.line===e.line&&t.ch<e.ch}(e)?{newAnchor:i,newHead:n}:{newAnchor:n,newHead:i}}(t,n);e.setSelection(i,o)}(e,n,o)}function p({oldCh:e,lineDiff:t}){const{oldLine:n,newLine:i}=t,o=n.length-i.length;return Math.clamp(e-o,0,i.length)}function L(e){const{from:t,to:n}=function(e){const{from:t,to:n}=w(e);return{from:{line:t.line,ch:0},to:{line:n.line,ch:e.getLine(n.line).length}}}(e);return{selectedLinesRange:{from:t,to:n},selectedLinesText:e.getRange(t,n)}}function S(e){const{anchor:t,head:n}=function(e){return{anchor:e.getCursor("anchor"),head:e.getCursor("head")}}(e),{from:i,to:o}=w(e);return{anchor:t,head:n,from:i,to:o}}function w(e){return{from:e.getCursor("from"),to:e.getCursor("to")}}const v=/^> \[!\w+\]/;const D={id:"remove-callout-from-selected-lines",name:"Remove callout from selected lines",editorCheckCallback:(y=function(e){const t=S(e),{selectedLinesRange:n,selectedLinesText:i}=L(e),o=c(i),{calloutID:l,effectiveTitle:s}=function(e){const t=function(e){const t=function(e){return u(d,e)}(e);if(void 0===t)throw new Error("Callout ID not found in callout text.");return t}(e),n=function(e,t){const n=function(e){return u(f,e)}(t);return""===n||void 0===n?m(e):n}(t,e);return{calloutID:t,effectiveTitle:n}}(i),a=function({calloutID:e,effectiveTitle:t,selectedLines:n}){return function({calloutID:e,title:t}){return t!==m(e)}({calloutID:e,title:t})?function(e,t){return[`###### ${e}`,...t.slice(1).map((e=>e.replace(/^> /,"")))]}(t,n):function(e){const t=e.slice(1).map((e=>e.replace(/^> /,"")));return t.length>0?t:[""]}(n)}({calloutID:l,effectiveTitle:s,selectedLines:o});C({editor:e,selectedLinesDiff:{oldLines:o,newLines:a},originalCursorPositions:t,selectedLinesRange:n})},(e,t,n)=>{if(!t.somethingSelected())return!1;const{selectedLinesText:i}=L(t);return!!v.test(i)&&function(e,t,n){return n||e(t),!0}(y,t,e)})};var y;function I(e,t){const n=S(e),{selectedLinesRange:i,selectedLinesText:o}=L(e),l=c(o),{title:s,rawBodyLines:a}=function(e,t){const[n,...i]=t,o=function({firstSelectedLine:e}){const t=function(e){return u(h,e)}(e);if(""!==t&&void 0!==t)return t}({firstSelectedLine:n});return void 0===o?{title:m(e),rawBodyLines:t}:{title:o,rawBodyLines:i}}(t,l),r=function({calloutID:e,title:t,rawBodyLines:n}){return[g({calloutID:e,title:t}),...n.map((e=>`> ${e}`))]}({calloutID:t,title:s,rawBodyLines:a});C({editor:e,selectedLinesDiff:{oldLines:l,newLines:r},originalCursorPositions:n,selectedLinesRange:i})}function b(e,t){return{id:s(e),name:`Wrap lines in ${e} callout`,editorCallback:n=>function(e,t,n){e.somethingSelected()?I(e,t):function({editor:e,calloutID:t,shouldSetSelection:n}){const i=e.getCursor(),{line:o}=i,l=e.getLine(o),s=function(e,t){const n=function(e){return g({calloutID:e,title:m(e)})}(e);return`${n}\n> ${t}`}(t,l);e.replaceRange(s,{line:o,ch:0},{line:o,ch:l.length}),function({editor:e,oldCursor:t,lineText:n,shouldSetSelection:i}){i?function({editor:e,oldCursor:{line:t,ch:n},lineText:i}){const o={line:t,ch:0},l=i.length+2,s={line:t+1,ch:Math.min(n+3,l)};e.setSelection(o,s)}({editor:e,oldCursor:t,lineText:n}):function(e,t){const{line:n,ch:i}=t;e.setCursor({line:n+1,ch:i+2})}(e,t)}({editor:e,oldCursor:i,lineText:l,shouldSetSelection:n})}({editor:e,calloutID:t,shouldSetSelection:n.getSetting("shouldSetSelectionAfterCurrentLineWrap")})}(n,e,t)}}class T{constructor(e,t){this.plugin=e,this.pluginSettingsManager=t,this.addedCommandCalloutIDsSet=new Set,this.onCalloutManagerChange=this.resyncCalloutCommands.bind(this)}onPluginUnload(){void 0!==this.calloutManager&&this.calloutManager.off("change",this.onCalloutManagerChange)}async setupCommands(){await this.setupCalloutManagerIfInstalled(),this.addAllCommands()}async setupCalloutManagerIfInstalled(){const e=await l(this.plugin);void 0!==e&&(this.calloutManager=e,this.calloutManager.on("change",this.onCalloutManagerChange))}resyncCalloutCommands(){const e=this.getAllCalloutIDs();this.removeOutdatedCalloutCommands(e),this.addMissingCalloutCommands(e)}getAllCalloutIDs(){return void 0===this.calloutManager?i:this.calloutManager.getCallouts().map((e=>e.id))}removeOutdatedCalloutCommands(e){r(Array.from(this.addedCommandCalloutIDsSet),new Set(e)).forEach((e=>this.removeWrapLinesInCalloutCommand(e)))}removeWrapLinesInCalloutCommand(e){const t=function({pluginID:e,calloutID:t}){return function(e,t){return`${e}:${t}`}(e,s(t))}({pluginID:this.plugin.manifest.id,calloutID:e});this.removeCommand({fullCommandID:t}),this.addedCommandCalloutIDsSet.delete(e)}addMissingCalloutCommands(e){r(e,this.addedCommandCalloutIDsSet).forEach((e=>this.addWrapLinesInCalloutCommand(e)))}addAllCommands(){this.addAllWrapLinesInCalloutCommands(),this.addCommand(D)}addAllWrapLinesInCalloutCommands(){this.getAllCalloutIDs().forEach((e=>this.addWrapLinesInCalloutCommand(e)))}addWrapLinesInCalloutCommand(e){const t=b(e,this.pluginSettingsManager);this.addCommand(t),this.addedCommandCalloutIDsSet.add(e)}addCommand(e){this.plugin.addCommand(e)}removeCommand({fullCommandID:e}){this.plugin.app.commands.removeCommand(e)}}const M={shouldSetSelectionAfterCurrentLineWrap:!1};class x extends n.PluginSettingTab{constructor(e){super(e.app,e),this.plugin=e,this.settings=Object.assign({},M)}async setupSettingsTab(){this.settings=await this.loadSettings(),this.addSettingTab()}async loadSettings(){const e=await this.plugin.loadData();return Object.assign({},M,e)}addSettingTab(){this.plugin.addSettingTab(this)}getSetting(e){return this.settings[e]}async setSetting(e,t){this.settings[e]=t,await this.saveSettings()}display(){const{containerEl:e}=this;e.empty(),new n.Setting(e).setName("Select text after inserting callout").setDesc(`Whether to select a callout's text after insertion, even if no text was selected before. This can be useful if you want to be able to run '${D.name}' immediately afterwards.`).addToggle(this.setupSetSelectionToggle.bind(this))}setupSetSelectionToggle(e){return(e=e.setValue(this.settings.shouldSetSelectionAfterCurrentLineWrap)).onChange(this.setSetting.bind(this,"shouldSetSelectionAfterCurrentLineWrap"))}async saveSettings(){await this.plugin.saveData(this.settings)}}class A extends n.Plugin{constructor(){super(...arguments),this.pluginSettingsManager=new x(this),this.pluginCommandManager=new T(this,this.pluginSettingsManager)}logInfo(e){console.log(`${this.manifest.name}: ${e}`)}async onload(){await this.pluginSettingsManager.setupSettingsTab(),this.app.workspace.onLayoutReady(this.onLayoutReady.bind(this))}async onLayoutReady(){await this.pluginCommandManager.setupCommands()}onunload(){this.pluginCommandManager.onPluginUnload()}}var P=exports;for(var $ in t)P[$]=t[$];t.__esModule&&Object.defineProperty(P,"__esModule",{value:!0})})();